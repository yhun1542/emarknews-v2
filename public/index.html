<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmarkNews - AI 실시간 뉴스</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* CSS 스타일은 제공해주신 원본과 동일하게 유지했습니다. */
        :root {
            --primary-color: #5a4fcf; --primary-light: #7c73e6; --primary-dark: #4338ca;
            --background-color: #f0f2f5; --surface-color: #ffffff; --text-color: #1e293b;
            --text-secondary: #64748b; --text-content: #334155; --border-color: #e2e8f0;
            --header-height: 68px; --nav-height: 53px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; line-height: 1.6; color: var(--text-color); background: var(--background-color); }
        .header { background: var(--surface-color); box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; height: var(--header-height); display: flex; align-items: center; }
        .header-container { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: center; padding: 0 1rem; width: 100%; }
        .logo { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; text-decoration: none; color: var(--text-color); }
        .logo-svg { width: 40px; height: 40px; }
        .logo-text { font-size: 28px; font-weight: 800; }
        .logo-com { color: var(--primary-color); font-size: 20px; font-weight: 700; }
        .nav { background: var(--surface-color); position: sticky; top: var(--header-height); z-index: 999; height: var(--nav-height); display: flex; align-items: center; border-bottom: 1px solid var(--border-color); }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; gap: 0.5rem; padding: 0 1rem; overflow-x: auto; white-space: nowrap; width: 100%; }
        .nav-item { background: var(--background-color); border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-weight: 600; color: var(--text-secondary); font-size: 0.9rem; transition: all 0.3s; }
        .nav-item.active { background: var(--primary-color); color: white; }
        .main { max-width: 1200px; margin: 1.5rem auto; padding: 0 1rem; }
        #loading { text-align: center; padding: 3rem; font-size: 1.1rem; color: var(--text-secondary); }
        .news-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
        .news-item { background: var(--surface-color); border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--border-color); display: flex; flex-direction: column; height: 100%; overflow: hidden; transition: all 0.3s ease; }
        .news-item:hover { box-shadow: 0 10px 15px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .news-content-wrapper { padding: 1.25rem; flex-grow: 1; display: flex; flex-direction: column; }
        .news-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; gap: 0.8rem 1rem; flex-wrap: wrap; }
        .news-source-time { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-secondary); flex-shrink: 1; min-width: 0; }
        .news-source { color: var(--primary-color); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .news-meta-group { display: flex; align-items: center; gap: 0.8rem; flex-wrap: wrap; margin-left: auto; }
        .news-tags { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .tag { padding: 0.2rem 0.6rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; color: white; }
        .tag.urgent { background: #dc2626; } .tag.important { background: #2563eb; } .tag.hot { background: #ef4444; } .tag.buzz { background: #a855f7; } .tag.default { background: var(--text-secondary); }
        .rating-badge { background: var(--primary-dark); color: white; padding: 0.3rem 0.7rem; border-radius: 15px; font-size: 0.8rem; font-weight: 700; white-space: nowrap; display: flex; align-items: center; gap: 0.3rem; }
        .rating-star { color: #FFD700; }
        .news-title-translated { font-size: 1.1rem; font-weight: 700; line-height: 1.4; margin-bottom: 0.8rem; }
        .summary-point { margin-bottom: 0.5rem; font-size: 0.95rem; font-weight: 600; color: #1e293b; line-height: 1.6; display: flex; align-items: flex-start; }
        .summary-bullet { color: var(--primary-color); margin-right: 0.5rem; flex-shrink: 0; padding-top: 2px; }
        .news-actions-wrapper { padding: 0.8rem 1.25rem; border-top: 1px solid var(--border-color); background: var(--surface-color); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .publish-date { font-size: 0.8rem; color: var(--text-secondary); font-weight: 500; }
        .view-details-btn { padding: 0.7rem 1.5rem; border-radius: 8px; font-size: 0.9rem; font-weight: 700; cursor: pointer; text-align: center; background: var(--primary-color); color: white; border: none; transition: background 0.3s ease; }
        .view-details-btn:hover { background: var(--primary-light); }
        @media (max-width: 768px) {
            :root { --header-height: 60px; --nav-height: 48px; } body { background: var(--surface-color); } .logo-svg { width: 32px; height: 32px; } .logo-text { font-size: 22px; } .logo-com { font-size: 16px; } .main { margin: 0; padding: 0; }
            .news-grid { display: block; height: calc(100dvh - var(--header-height) - var(--nav-height)); height: calc(100vh - var(--header-height) - var(--nav-height)); overflow-y: auto; scroll-snap-type: y mandatory; }
            .news-item { height: 100%; scroll-snap-align: start; border-radius: 0; box-shadow: none; border: none; border-bottom: 8px solid var(--background-color); }
            .news-content-wrapper { padding: 1.5rem 1rem; overflow-y: auto; height: 100%; }
            .news-title-translated { font-size: 1.5rem; }
            .news-actions-wrapper { padding: 1rem; margin-top: 1.5rem; background: transparent; }
            .view-details-btn { padding: 1rem; }
        }
        @media (min-width: 769px) and (max-width: 1024px) { .news-grid { grid-template-columns: repeat(2, 1fr); } }
        .nav-container::-webkit-scrollbar, .news-grid::-webkit-scrollbar, .news-content-wrapper::-webkit-scrollbar { display: none; }
        .nav-container, .news-grid, .news-content-wrapper { -ms-overflow-style: none; scrollbar-width: none; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { text-align: center; padding: 2rem; color: var(--text-secondary); }
        .error-message h3 { color: #dc2626; margin-bottom: 1rem; }
        .retry-button { max-width: 200px; margin: 1rem auto; }
        .update-notification {
            position: fixed; top: 80px; right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 12px 20px; border-radius: 8px;
            font-size: 14px; font-weight: 500; z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(120%); transition: transform 0.4s ease-in-out;
        }
        .update-notification.show { transform: translateX(0); }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <a href="/" class="logo">
                <img src="/logo.svg" alt="EmarkNews Logo" class="logo-svg" />
                <span class="logo-text">EmarkNews</span><span class="logo-com">.com</span>
            </a>
        </div>
    </header>

    <nav class="nav">
        <div class="nav-container">
            <button class="nav-item active" data-section="world">🌍 세계</button>
            <button class="nav-item" data-section="kr">🇰🇷 한국</button>
            <button class="nav-item" data-section="japan">🇯🇵 일본</button>
            <button class="nav-item" data-section="buzz">🔥 Buzz</button>
            <button class="nav-item" data-section="tech">💡 테크</button>
            <button class="nav-item" data-section="business">💼 BIZ</button>
        </div>
    </nav>

    <main class="main">
        <div id="loading">
            <div class="spinner"></div>
            <p>최신 뉴스를 불러오는 중입니다...</p>
        </div>
        <div id="news-grid" class="news-grid" style="display: none;"></div>
        <div id="error" class="error-message" style="display: none;">
            <h3>오류가 발생했습니다</h3>
            <p id="error-text"></p>
            <button onclick="location.reload()" class="view-details-btn retry-button">
                새로고침
            </button>
        </div>
    </main>

    <script>
        class EmarkNews {
            constructor() {
                // 프론트엔드와 백엔드가 같은 도메인에서 서비스되므로 상대 경로 사용
                this.API_BASE_URL = ''; 
                this.currentSection = 'world';
                this.articles = [];
                this.isMobileView = window.innerWidth <= 768;
                this.init();
            }

            init() {
                this.newsGrid = document.getElementById('news-grid');
                this.setupNavigation();
                this.setupDetailButtonListener(); // [개선] 이벤트 위임 방식으로 리스너 설정
                this.setupWebSocket();
                this.loadNews(this.currentSection);
                
                window.addEventListener('resize', () => {
                    const wasMobile = this.isMobileView;
                    this.isMobileView = window.innerWidth <= 768;
                    if (wasMobile !== this.isMobileView) {
                        this.displayNews(this.articles);
                    }
                });
            }

            setupNavigation() {
                document.querySelector('.nav-container').addEventListener('click', (e) => {
                    if (e.target.matches('.nav-item')) {
                        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentSection = e.target.dataset.section;
                        this.loadNews(this.currentSection);
                        this.scrollToTop();
                    }
                });
            }

            // [개선] 이벤트 위임(Event Delegation) 방식으로 '상세보기' 버튼 리스너를 설정합니다.
            // 이 방식은 더 효율적이고 안정적이며, 이전에 발생했던 링크 오류 문제를 근본적으로 해결합니다.
            setupDetailButtonListener() {
                this.newsGrid.addEventListener('click', (e) => {
                    const button = e.target.closest('.view-details-btn');
                    if (button) {
                        e.preventDefault();
                        const articleId = button.dataset.articleId;
                        const section = button.dataset.section;
                        if (articleId && section) {
                            this.openDetailPage(articleId, section);
                        } else {
                            alert('기사 정보를 찾을 수 없습니다.');
                        }
                    }
                });
            }

            async loadNews(section, isUpdate = false) {
                if (!isUpdate) { // 자동 업데이트가 아닐 때만 로딩 화면 표시
                    this.showLoading();
                }

                // AI 기능이 포함된 '/full' 엔드포인트를 호출하여 항상 완전한 데이터를 받습니다.
                const url = `${this.API_BASE_URL}/api/${section}/full`;

                try {
                    // 브라우저 캐시는 사용하지 않지만, 서버의 Redis 캐시를 통해 빠른 응답을 받습니다.
                    const response = await fetch(url, { cache: 'no-store' });
                    
                    if (!response.ok) {
                        throw new Error(`서버 응답 오류: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && Array.isArray(data.data)) {
                        this.articles = data.data;
                        this.displayNews(this.articles);
                    } else {
                        throw new Error(data.message || '데이터 형식이 올바르지 않습니다.');
                    }
                } catch (error) {
                    console.error('Failed to load news:', error);
                    const errorMessage = error.message.includes('Failed to fetch') 
                        ? '서버에 연결할 수 없습니다. 잠시 후 다시 시도해주세요.' 
                        : error.message;
                    this.showError(errorMessage);
                }
            }

            displayNews(articles) {
                if (!articles || articles.length === 0) {
                    this.showError('이 섹션에는 표시할 뉴스가 없습니다.');
                    return;
                }
                this.newsGrid.innerHTML = articles.map(article => this.createArticleCard(article)).join('');
                this.hideLoading();
                this.newsGrid.style.display = this.isMobileView ? 'block' : 'grid';
            }

            createArticleCard(article) {
                const timeAgo = this.getTimeAgo(article.publishedAt);
                const rating = parseFloat(article.rating) || 3.0;
                const displayTitle = article.titleKo || article.title;
                const summaryPoints = (article.summaryPoints && article.summaryPoints.length > 0)
                    ? article.summaryPoints 
                    : [article.description || '요약 정보가 없습니다.'];
                
                const tagsHtml = (article.tags || [])
                    .map(tag => `<span class="tag ${this.getTagClass(tag)}">${tag}</span>`)
                    .join('');
                
                const summaryHtml = summaryPoints
                    .slice(0, this.isMobileView ? 15 : 3)
                    .map(point => {
                        const cleanPoint = point.replace(/^\.\s*/, '');
                        return `<div class="summary-point"><span class="summary-bullet">•</span><span class="summary-text">${this.escapeHtml(cleanPoint)}</span></div>`;
                    }).join('');
                
                const publishDate = this.formatPublishDate(article.publishedAt);
                const actionsHtml = `
                    <div class="news-actions-wrapper">
                        <div class="publish-date">${publishDate}</div>
                        <button class="view-details-btn" data-article-id="${article.id}" data-section="${this.currentSection}">
                            ✨ 상세보기
                        </button>
                    </div>
                `;

                return `
                    <article class="news-item" data-id="${article.id}">
                        <div class="news-content-wrapper">
                            <div class="news-header">
                                <div class="news-source-time">
                                    <span class="news-source">${this.escapeHtml(this.truncateSource(article.source || 'Unknown'))}</span>
                                    <span>·</span>
                                    <span class="time-ago">${timeAgo}</span>
                                </div>
                                <div class="news-meta-group">
                                    ${tagsHtml ? `<div class="news-tags">${tagsHtml}</div>` : ''}
                                    <div class="rating-badge"><span class="rating-star">⭐</span>${rating.toFixed(1)}</div>
                                </div>
                            </div>
                            <h2 class="news-title-translated">${this.escapeHtml(displayTitle)}</h2>
                            <div class="ai-summary-main">${summaryHtml}</div>
                        </div>
                        ${actionsHtml}
                    </article>
                `;
            }
            
            openDetailPage(articleId, section) {
                const article = this.articles.find(a => a.id === articleId);
                if (!article) {
                    alert('기
