<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmarkNews - AI 실시간 뉴스</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --primary-color: #5a4fcf; --primary-light: #7c73e6; --primary-dark: #4338ca;
            --background-color: #f0f2f5; --surface-color: #ffffff; --text-color: #1e293b;
            --text-secondary: #64748b; --text-content: #334155; --border-color: #e2e8f0;
            --header-height: 68px; --nav-height: 53px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; line-height: 1.6; color: var(--text-color); background: var(--background-color); }
        .header { background: var(--surface-color); box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; height: var(--header-height); display: flex; align-items: center; }
        .header-container { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: center; padding: 0 1rem; width: 100%; }
        .logo { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; text-decoration: none; color: var(--text-color); }
        .logo-svg { width: 40px; height: 40px; }
        .logo-text { font-size: 28px; font-weight: 800; }
        .logo-com { color: var(--primary-color); font-size: 20px; font-weight: 700; }
        .nav { background: var(--surface-color); position: sticky; top: var(--header-height); z-index: 999; height: var(--nav-height); display: flex; align-items: center; border-bottom: 1px solid var(--border-color); }
        .nav-container { max-width: 1200px; margin: 0 auto; display: flex; gap: 0.5rem; padding: 0 1rem; overflow-x: auto; white-space: nowrap; width: 100%; }
        .nav-item { background: var(--background-color); border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-weight: 600; color: var(--text-secondary); font-size: 0.9rem; transition: all 0.3s; }
        .nav-item.active { background: var(--primary-color); color: white; }
        .main { max-width: 1200px; margin: 1.5rem auto; padding: 0 1rem; }
        #loading { text-align: center; padding: 3rem; font-size: 1.1rem; color: var(--text-secondary); }
        .news-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
        .news-item { background: var(--surface-color); border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--border-color); display: flex; flex-direction: column; height: 100%; overflow: hidden; transition: all 0.3s ease; }
        .news-item:hover { box-shadow: 0 10px 15px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .news-content-wrapper { padding: 1.25rem; flex-grow: 1; display: flex; flex-direction: column; }
        .news-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; gap: 0.8rem 1rem; flex-wrap: wrap; }
        .news-source-time { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-secondary); flex-shrink: 1; min-width: 0; }
        .news-source { color: var(--primary-color); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .news-meta-group { display: flex; align-items: center; gap: 0.8rem; flex-wrap: wrap; margin-left: auto; }
        .news-tags { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .tag { padding: 0.2rem 0.6rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; color: white; }
        .tag.urgent { background: #dc2626; } .tag.important { background: #2563eb; } .tag.hot { background: #ef4444; } .tag.buzz { background: #a855f7; } .tag.default { background: var(--text-secondary); }
        .rating-badge { background: var(--primary-dark); color: white; padding: 0.3rem 0.7rem; border-radius: 15px; font-size: 0.8rem; font-weight: 700; white-space: nowrap; display: flex; align-items: center; gap: 0.3rem; }
        .rating-star { color: #FFD700; }
        .news-title-translated { font-size: 1.1rem; font-weight: 700; line-height: 1.4; margin-bottom: 0.8rem; }
        .summary-point { margin-bottom: 0.5rem; font-size: 0.95rem; font-weight: 600; color: #1e293b; line-height: 1.6; display: flex; align-items: flex-start; }
        .summary-bullet { color: var(--primary-color); margin-right: 0.5rem; flex-shrink: 0; padding-top: 2px; }
        .news-actions-wrapper { padding: 0.8rem 1.25rem; border-top: 1px solid var(--border-color); background: var(--surface-color); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        .publish-date { font-size: 0.8rem; color: var(--text-secondary); font-weight: 500; }
        .view-details-btn { padding: 0.7rem 1.5rem; border-radius: 8px; font-size: 0.9rem; font-weight: 700; cursor: pointer; text-align: center; background: var(--primary-color); color: white; border: none; transition: background 0.3s ease; }
        .view-details-btn:hover { background: var(--primary-light); }
        @media (max-width: 768px) {
            :root { --header-height: 60px; --nav-height: 48px; } body { background: var(--surface-color); } .logo-svg { width: 32px; height: 32px; } .logo-text { font-size: 22px; } .logo-com { font-size: 16px; } .main { margin: 0; padding: 0; }
            .news-grid { display: block; height: calc(100dvh - var(--header-height) - var(--nav-height)); height: calc(100vh - var(--header-height) - var(--nav-height)); overflow-y: auto; scroll-snap-type: y mandatory; }
            .news-item { height: 100%; scroll-snap-align: start; border-radius: 0; box-shadow: none; border: none; border-bottom: 8px solid var(--background-color); display: flex; flex-direction: column; min-height: 100vh; }
            .news-content-wrapper { padding: 1.5rem 1rem 0.5rem 1rem; flex: 1; display: flex; flex-direction: column; }
            .news-title-translated { font-size: 1.5rem; }
            .news-actions-wrapper { padding: 1rem; margin-top: auto; background: transparent; flex-shrink: 0; position: sticky; bottom: 0; background: var(--surface-color); border-top: 1px solid var(--border-color); }
            .view-details-btn { padding: 1rem 2rem; width: 100%; font-size: 1rem; border-radius: 12px; }
        }
        @media (min-width: 769px) and (max-width: 1024px) { .news-grid { grid-template-columns: repeat(2, 1fr); } }
        .nav-container::-webkit-scrollbar, .news-grid::-webkit-scrollbar, .news-content-wrapper::-webkit-scrollbar { display: none; }
        .nav-container, .news-grid, .news-content-wrapper { -ms-overflow-style: none; scrollbar-width: none; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { text-align: center; padding: 2rem; color: var(--text-secondary); }
        .error-message h3 { color: #dc2626; margin-bottom: 1rem; }
        .retry-button { max-width: 200px; margin: 1rem auto; }
        .update-notification {
            position: fixed; top: 80px; right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 12px 20px; border-radius: 8px;
            font-size: 14px; font-weight: 500; z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(120%); transition: transform 0.4s ease-in-out;
        }
        .update-notification.show { transform: translateX(0); }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <a href="/" class="logo">
                <img src="/logo.svg" alt="EmarkNews Logo" class="logo-svg" />
                <span class="logo-text">EmarkNews</span><span class="logo-com">.com</span>
            </a>
        </div>
    </header>

    <nav class="nav">
        <div class="nav-container">
            <button class="nav-item active" data-section="world">🌍 세계</button>
            <button class="nav-item" data-section="kr">🇰🇷 한국</button>
            <button class="nav-item" data-section="japan">🇯🇵 일본</button>
            <button class="nav-item" data-section="buzz">🔥 Buzz</button>
            <button class="nav-item" data-section="tech">💡 테크</button>
            <button class="nav-item" data-section="business">💼 BIZ</button>
        </div>
    </nav>

    <main class="main">
        <div id="loading">
            <div class="spinner"></div>
            <p>최신 뉴스를 불러오는 중입니다...</p>
        </div>
        <div id="news-grid" class="news-grid" style="display: none;"></div>
        <div id="error" class="error-message" style="display: none;">
            <h3>오류가 발생했습니다</h3>
            <p id="error-text"></p>
            <button onclick="location.reload()" class="view-details-btn retry-button">
                새로고침
            </button>
        </div>
    </main>

    <script>
        class EmarkNews {
            constructor() {
                // 프론트엔드와 백엔드가 같은 도메인에서 서비스되므로 상대 경로 사용
                this.API_BASE_URL = ''; 
                this.currentSection = 'world';
                this.articles = [];
                this.isMobileView = window.innerWidth <= 768;
                this.init();
            }

            init() {
                this.newsGrid = document.getElementById('news-grid');
                this.setupNavigation();
                this.setupDetailButtonListener(); // [개선] 이벤트 위임 방식으로 리스너 설정
                this.setupWebSocket();
                this.loadNews(this.currentSection);
                
                window.addEventListener('resize', () => {
                    const wasMobile = this.isMobileView;
                    this.isMobileView = window.innerWidth <= 768;
                    if (wasMobile !== this.isMobileView) {
                        this.displayNews(this.articles);
                    }
                });
            }

            setupNavigation() {
                document.querySelector('.nav-container').addEventListener('click', (e) => {
                    if (e.target.matches('.nav-item')) {
                        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentSection = e.target.dataset.section;
                        this.loadNews(this.currentSection);
                        this.scrollToTop();
                    }
                });
            }

            // [개선] 이벤트 위임(Event Delegation) 방식으로 '상세보기' 버튼 리스너를 설정합니다.
            // 이 방식은 더 효율적이고 안정적이며, 이전에 발생했던 링크 오류 문제를 근본적으로 해결합니다.
            setupDetailButtonListener() {
                this.newsGrid.addEventListener('click', (e) => {
                    // 상세보기 버튼 클릭 처리
                    if (e.target.classList.contains('view-details-btn') || e.target.closest('.view-details-btn')) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const button = e.target.classList.contains('view-details-btn') ? e.target : e.target.closest('.view-details-btn');
                        const articleId = button.getAttribute('data-article-id');
                        const section = button.getAttribute('data-section');
                        
                        console.log('Detail button clicked:', { articleId, section });
                        
                        if (articleId && section) {
                            this.openDetailPage(articleId, section);
                        } else {
                            console.error('Missing article data:', { articleId, section });
                            alert('기사 정보를 찾을 수 없습니다.');
                        }
                    }
                });
            }

            async loadNews(section, isUpdate = false) {
                if (!isUpdate) { // 자동 업데이트가 아닐 때만 로딩 화면 표시
                    this.showLoading();
                }

                // [수정 1] 항상 빠른 응답을 보장하는 /fast 엔드포인트를 다시 사용합니다.
                const url = `${this.API_BASE_URL}/api/${section}/fast`;

                try {
                    const response = await fetch(url, { cache: 'no-store' });
                    
                    if (!response.ok) {
                        throw new Error(`서버 응답 오류: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && Array.isArray(data.data)) {
                        this.articles = data.data;
                        this.displayNews(this.articles);

                        // [수정 2] 만약 지금 받은 데이터가 '부분 데이터(partial)'라면,
                        // 10초 후에 완전한 데이터를 다시 요청하는 타이머를 설정합니다.
                        if (data.partial) {
                            console.log('Partial data received. Scheduling a refresh in 10 seconds...');
                            setTimeout(() => {
                                // isUpdate 플래그를 true로 설정하여 로딩 화면 없이 조용히 업데이트합니다.
                                this.loadNews(section, true);
                            }, 10000); // 10초
                        } else {
                            console.log('Full data received. No refresh scheduled.');
                        }

                    } else {
                        throw new Error(data.message || '데이터 형식이 올바르지 않습니다.');
                    }
                } catch (error) {
                    console.error('Failed to load news:', error);
                    const errorMessage = error.message.includes('Failed to fetch') 
                        ? '서버에 연결할 수 없습니다. 잠시 후 다시 시도해주세요.' 
                        : error.message;
                    if (!isUpdate) { // 자동 업데이트 실패 시에는 에러 메시지를 띄우지 않음
                        this.showError(errorMessage);
                    }
                }
            }

            displayNews(articles) {
                if (!articles || articles.length === 0) {
                    this.showError('이 섹션에는 표시할 뉴스가 없습니다.');
                    return;
                }
                this.newsGrid.innerHTML = articles.map(article => this.createArticleCard(article)).join('');
                this.hideLoading();
                this.newsGrid.style.display = this.isMobileView ? 'block' : 'grid';
            }

            createArticleCard(article) {
                const timeAgo = this.getTimeAgo(article.publishedAt);
                const rating = parseFloat(article.rating) || 3.0;
                const displayTitle = article.titleKo || article.title;
                const summaryPoints = (article.summaryPoints && article.summaryPoints.length > 0)
                    ? article.summaryPoints 
                    : [article.description || '요약 정보가 없습니다.'];
                
                const tagsHtml = (article.tags || [])
                    .map(tag => `<span class="tag ${this.getTagClass(tag)}">${this.escapeHtml(tag)}</span>`)
                    .join('');
                
                const summaryHtml = summaryPoints
                    .slice(0, this.isMobileView ? 15 : 3)
                    .map(point => {
                        const cleanPoint = point.replace(/^\.\s*/, '');
                        return `<div class="summary-point"><span class="summary-bullet">•</span><span class="summary-text">${this.escapeHtml(cleanPoint)}</span></div>`;
                    }).join('');
                
                const publishDate = this.formatPublishDate(article.publishedAt);
                const actionsHtml = `
                    <div class="news-actions-wrapper">
                        <div class="publish-date">${publishDate}</div>
                        <button class="view-details-btn" data-article-id="${article.id}" data-section="${this.currentSection}">
                            ✨ 상세보기
                        </button>
                    </div>
                `;

                return `
                    <article class="news-item" data-id="${article.id}">
                        <div class="news-content-wrapper">
                            <div class="news-header">
                                <div class="news-source-time">
                                    <span class="news-source">${this.escapeHtml(this.truncateSource(article.source || 'Unknown'))}</span>
                                    <span>·</span>
                                    <span class="time-ago">${timeAgo}</span>
                                </div>
                                <div class="news-meta-group">
                                    ${tagsHtml ? `<div class="news-tags">${tagsHtml}</div>` : ''}
                                    <div class="rating-badge"><span class="rating-star">⭐</span>${rating.toFixed(1)}</div>
                                </div>
                            </div>
                            <h2 class="news-title-translated">${this.escapeHtml(displayTitle)}</h2>
                            <div class="ai-summary-main">${summaryHtml}</div>
                        </div>
                        ${actionsHtml}
                    </article>
                `;
            }
            
            openDetailPage(articleId, section) {
                console.log('Opening detail page for:', { articleId, section });
                
                const article = this.articles.find(a => a.id === articleId);
                if (!article) {
                    console.error('Article not found:', articleId);
                    alert('기사를 찾을 수 없습니다.');
                    return;
                }
                
                try {
                    // 세션 스토리지에 기사 데이터 저장
                    const storageKey = `article_${section}_${articleId}`;
                    sessionStorage.setItem(storageKey, JSON.stringify(article));
                    sessionStorage.setItem('isOpenedByScript', 'true');
                    
                    // 상세 페이지 URL 생성
                    const detailUrl = `/detail.html?section=${encodeURIComponent(section)}&id=${encodeURIComponent(articleId)}`;
                    
                    // 새 창으로 열기
                    const newWindow = window.open(detailUrl, '_blank', 'noopener,noreferrer');
                    
                    if (!newWindow) {
                        // 팝업이 차단된 경우 현재 창에서 열기
                        window.location.href = detailUrl;
                    }
                } catch (error) {
                    console.error('Error opening detail page:', error);
                    alert('상세 페이지를 열 수 없습니다.');
                }
            }

            setupWebSocket() {
                try {
                    const socket = io();

                    socket.on('connect', () => console.log('✅ WebSocket connected'));
                    socket.on('disconnect', () => console.log('❌ WebSocket disconnected'));

                    socket.on('cache-updated', (data) => {
                        console.log(`📰 Cache update notification received for section: ${data.section}`);
                        if (this.currentSection === data.section) {
                            this.showUpdateNotification(data.message);
                            setTimeout(() => this.loadNews(this.currentSection, true), 1000);
                        }
                    });
                } catch (e) {
                    console.warn('WebSocket connection failed. Real-time updates disabled.', e);
                }
            }
            
            showUpdateNotification(message) {
                let notification = document.querySelector('.update-notification');
                if (!notification) {
                    notification = document.createElement('div');
                    notification.className = 'update-notification';
                    document.body.appendChild(notification);
                }
                notification.innerHTML = `<span>🔄</span> <span>${message}</span>`;
                
                setTimeout(() => notification.classList.add('show'), 10);
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            // --- 유틸리티 함수들 ---
            getTagClass(tag) { const map = { '긴급': 'urgent', '중요': 'important', 'Hot': 'hot', 'Buzz': 'buzz' }; return map[tag] || 'default'; }
            formatPublishDate(d) { if (!d) return ''; const dt = new Date(d); return `${dt.getFullYear()}.${String(dt.getMonth() + 1).padStart(2, '0')}.${String(dt.getDate()).padStart(2, '0')} ${String(dt.getHours()).padStart(2, '0')}:${String(dt.getMinutes()).padStart(2, '0')}`; }
            getTimeAgo(d) { if (!d) return ''; const diff = (new Date() - new Date(d)) / 60000; if (diff < 1) return '방금 전'; if (diff < 60) return `${Math.floor(diff)}분 전`; if (diff < 1440) return `${Math.floor(diff / 60)}시간 전`; return `${Math.floor(diff / 1440)}일 전`; }
            escapeHtml(s) { if(typeof s !=='string') return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
            truncateSource(s) { return (s && s.length > 20) ? s.substring(0, 18) + '...' : s; }
            scrollToTop() { const t = this.isMobileView ? this.newsGrid : window; t.scrollTo({ top: 0, behavior: 'smooth' }); }
            showLoading() { document.getElementById('loading').style.display = 'block'; document.getElementById('news-grid').style.display = 'none'; document.getElementById('error').style.display = 'none'; }
            hideLoading() { document.getElementById('loading').style.display = 'none'; }
            showError(m) { document.getElementById('loading').style.display = 'none'; document.getElementById('news-grid').style.display = 'none'; const e = document.getElementById('error'); e.style.display = 'block'; document.getElementById('error-text').textContent = m; }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.newsApp = new EmarkNews();
        });
    </script>
</body>
</html>
